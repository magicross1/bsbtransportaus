# 核心配置
user www-data;
worker_processes auto;
pid /run/nginx.pid;

# 添加 events 块（必需）
events {
    worker_connections 1024;  # 这是常见配置，可根据需要调整
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;
        listen [::]:80;
        server_name _;

        # 网站根目录
        root /var/www/bsbtransport/public;
        index 200.html;

        # 主请求处理（SPA 回退到 200.html）
        location / {
            try_files $uri /200.html;
        }

        # 显式修正 JS/MJS 的 MIME，避免被当做 text/plain
        location ~* \.(?:js|mjs)$ {
            types { application/javascript js mjs; }
            default_type application/javascript;
            try_files $uri =404;
            access_log off;
            expires 7d;
            add_header Cache-Control "public, max-age=604800, immutable";
        }

        # 静态资源缓存
        location ~* \.(?:js|mjs|css|png|jpg|jpeg|gif|webp|avif|svg|ico|woff2?)$ {
            expires 30d;
            access_log off;
            add_header Cache-Control "public, max-age=2592000, immutable";
            try_files $uri =404;
        }
    }

    # HTTPS 主配置
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name _;
        
        # SSL 证书
        ssl_certificate /etc/nginx/ssl/bsb.cert;
        ssl_certificate_key /etc/nginx/ssl/bsb.key;
        
        # SSL 增强配置（必须添加）
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # HSTS 安全头（推荐）
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
        
        # 网站根目录
        root /var/www/bsbtransport/public;
        index 200.html;

        # 主请求处理（SPA 回退到 200.html）
        location / {
            try_files $uri /200.html;
        }

        # 显式修正 JS/MJS 的 MIME，避免被当做 text/plain
        location ~* \.(?:js|mjs)$ {
            types { application/javascript js mjs; }
            default_type application/javascript;
            try_files $uri =404;
            access_log off;
            expires 7d;
            add_header Cache-Control "public, max-age=604800, immutable";
        }

        # 静态资源缓存（从HTTP配置复制）
        location ~* \.(?:js|mjs|css|png|jpg|jpeg|gif|webp|avif|svg|ico|woff2?)$ {
            expires 30d;
            access_log off;
            add_header Cache-Control "public, max-age=2592000, immutable";
            try_files $uri =404;
        }
    }
}